# Асинхронный клиент
## PUT-запросы
Нагрузочное тестирование с помощью wrk2 проводилось со следующими настройками:
- 4 потока, 16 соединений
- время обстрела - 60 секунд
- стабильная нагрузка 4000 запросов в секунду
- параметр "replicas" не указан, "aсk" берется по кворуму - 2/3

Результаты нагрузочного тестирования:

    wrk -t4 -c16 -d60s -s ./put.lua -R4000 --latency http://127.0.0.1:8080
    Running 1m test @ http://127.0.0.1:8080
      4 threads and 16 connections
      Thread calibration: mean lat.: 2.251ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 2.266ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 2.120ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 2.256ms, rate sampling interval: 10ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     2.23ms    1.66ms  33.54ms   91.09%
        Req/Sec     1.05k   194.27     2.44k    79.96%
      Latency Distribution (HdrHistogram - Recorded Latency)
     50.000%    1.85ms
     75.000%    2.52ms
     90.000%    3.62ms
     99.000%    8.18ms
     99.900%   21.33ms
     99.990%   29.45ms
     99.999%   32.30ms
    100.000%   33.57ms
    
      Detailed Percentile spectrum:
           Value   Percentile   TotalCount 1/(1-Percentile)
    
           0.356     0.000000            1         1.00
           1.034     0.100000        20057         1.11
           1.280     0.200000        40010         1.25
           1.481     0.300000        60027         1.43
           1.661     0.400000        80051         1.67
           1.849     0.500000       100075         2.00
           1.952     0.550000       109982         2.22
           2.071     0.600000       120037         2.50
           2.205     0.650000       129969         2.86
           2.349     0.700000       139954         3.33
           2.523     0.750000       149974         4.00
           2.623     0.775000       154960         4.44
           2.743     0.800000       159949         5.00
           2.891     0.825000       164978         5.71
           3.071     0.850000       169975         6.67
           3.301     0.875000       174943         8.00
           3.449     0.887500       177451         8.89
           3.619     0.900000       179939        10.00
           3.821     0.912500       182435        11.43
           4.093     0.925000       184933        13.33
           4.451     0.937500       187450        16.00
           4.651     0.943750       188676        17.78
           4.879     0.950000       189936        20.00
           5.163     0.956250       191184        22.86
           5.479     0.962500       192425        26.67
           5.823     0.968750       193677        32.00
           6.035     0.971875       194307        35.56
           6.287     0.975000       194927        40.00
           6.571     0.978125       195546        45.71
           6.859     0.981250       196175        53.33
           7.235     0.984375       196798        64.00
           7.443     0.985938       197112        71.11
           7.675     0.987500       197422        80.00
           7.959     0.989062       197736        91.43
           8.327     0.990625       198046       106.67
           8.807     0.992188       198358       128.00
           9.127     0.992969       198516       142.22
           9.535     0.993750       198674       160.00
          10.031     0.994531       198828       182.86
          10.767     0.995313       198982       213.33
          11.815     0.996094       199140       256.00
          12.383     0.996484       199218       284.44
          13.183     0.996875       199295       320.00
          13.991     0.997266       199375       365.71
          15.007     0.997656       199451       426.67
          16.327     0.998047       199529       512.00
          17.183     0.998242       199568       568.89
          18.159     0.998437       199607       640.00
          19.039     0.998633       199646       731.43
          20.207     0.998828       199685       853.33
          21.471     0.999023       199724      1024.00
          22.095     0.999121       199744      1137.78
          22.735     0.999219       199763      1280.00
          23.279     0.999316       199783      1462.86
          24.031     0.999414       199802      1706.67
          24.895     0.999512       199822      2048.00
          25.183     0.999561       199832      2275.56
          25.375     0.999609       199841      2560.00
          25.919     0.999658       199851      2925.71
          26.495     0.999707       199861      3413.33
          26.911     0.999756       199873      4096.00
          27.087     0.999780       199876      4551.11
          27.599     0.999805       199880      5120.00
          27.775     0.999829       199885      5851.43
          28.399     0.999854       199891      6826.67
          28.991     0.999878       199895      8192.00
          29.391     0.999890       199898      9102.22
          29.455     0.999902       199900     10240.00
          29.503     0.999915       199902     11702.86
          30.031     0.999927       199905     13653.33
          30.143     0.999939       199907     16384.00
          30.303     0.999945       199909     18204.44
          30.623     0.999951       199910     20480.00
          30.639     0.999957       199911     23405.71
          30.911     0.999963       199912     27306.67
          31.071     0.999969       199913     32768.00
          31.679     0.999973       199914     36408.89
          32.159     0.999976       199915     40960.00
          32.159     0.999979       199915     46811.43
          32.287     0.999982       199916     54613.33
          32.287     0.999985       199916     65536.00
          32.303     0.999986       199917     72817.78
          32.303     0.999988       199917     81920.00
          32.303     0.999989       199917     93622.86
          33.375     0.999991       199918    109226.67
          33.375     0.999992       199918    131072.00
          33.375     0.999993       199918    145635.56
          33.375     0.999994       199918    163840.00
          33.375     0.999995       199918    187245.71
          33.567     0.999995       199919    218453.33
          33.567     1.000000       199919          inf
    #[Mean    =        2.229, StdDeviation   =        1.656]
    #[Max     =       33.536, Total count    =       199919]
    #[Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
      239972 requests in 1.00m, 15.33MB read
    Requests/sec:   3999.53
    Transfer/sec:    261.69KB
    
По результатам нагрузочного тестирования видно, что скорость обработки запросов по сравнению с предыдущим этапом увеличивается (в 2.78 раз для 99.9% запросов и в 2.08 раз для 99.999% запросов), что объясняется введением асинхронного выполнения запросов, таким образом, обращение к репликам идет параллельно, и сервер быстрее получает требуемое количество ответов (на предыдущем этапе сервер ждал, когда придет ответ от реплики, и только после этого отправлял запрос к следующей реплике). 
Также введена оптимизация, позволяющая не ждать ответ от всех реплик, а сформировать итоговый ответ при получении отклика от aсk реплик.

#### async-profiler cpu

![async-profiler put cpu](pictures/stage6/cpu_put.svg)

 - 66.04% процессорного времени уходит на работу в пуле потоков (ThreadPoolExecutor.runWorker) 
 - 18.08% времени уходит на работу селектора сервера (SelectorThread.run)
 - 9.88% времени занимает селектор http-клиента (HttpClientImpl$SelectorManager.run)
 
 В пуле потоков потребление процессорного времени распределяется следующим образом:
 
 - 14.15% уходит на scheduler http-клиента (SequentialScheduler$SchedulableTask.run)
 - 10.71% занимает канал выдачи ответов от http-клиента (SocketTube)
 - 9.34% занимает получение задачи из пула потоков (ThreadPoolExecutor.getTask)
 - 4.86% уходит на завершение future и отправку ответа (Util.SendResponseFromFuture)
 - 26.24% занимают локальные вычисления (CompletableFuture.AsyncSupply)
 
 Локальные вычисления включают в себя:
 
 - сохранение данных в базу (BasicService.put - 12.63%)
 - отправку ответа серверу, после завершения сохранения (CompletableFuture.PostComplete - 13.56%)

#### async-profiler alloc

![async-profiler put alloc](pictures/stage6/alloc_put.svg)

 - 40.06% памяти уходит на selectorThread
 - 3.56% памяти уходит на работу селектора http-клиента (HttpClientImpl$SelectorManager.run)
 - 56.20% памяти уходит на пул потоков
 
 В пуле потоков потребление памяти распределяется следующим образом:
 
 - 37.61% памяти потребляют локальные вычисления (в том числе, 20.80% памяти выделяется при сохранении данных в базу)
 - 8.37% памяти выделяется на завершение future и отправку ответа (CompletableFuture.Completion.run)
 - 3.06% памяти выделяется при получении задачи из пула потоков (ThreadPoolExecutor.getTask)
 - 1.68% памяти выделяется для канала выдачи ответов от http-клиента (SocketTube)
 - 5.49% памяти выделяется для scheduler http-клиента (SequentialScheduler$SchedulableTask.run)

#### async-profiler lock

![async-profiler put lock](pictures/stage6/lock_put.svg)

 - 35.41% блокировок происходят в менеджере http-клиента и связаны с с выбором задач на исполнение в асинхронном клиенте
 - 1.28% блокировок связан с работой селектора сервера
 - 62.92% блокировок связаны с работой в пуле потоков
 
 В пуле потоков блокировки распределяются следующим образом:
 
 - 37.05% блокировок связаны с scheduler http-клиента и представляют собой, в основном, блокировки ConnectionPool и селектора
 - 1.92% блокировок связаны с получением задачи из пула потоков (ThreadPoolExecutor.getTask)
 - 23.72% блокировок связаны с локальными вычислениями (завершение future и отправка ответа от реплики) и представляют собой, в основном, блокировки ConnectionPool и селектора http-клиента

## GET-запросы
Нагрузочное тестирование с помощью wrk2 проводилось на заполненной базе со следующими настройками:
- 4 потока, 16 соединений
- время обстрела - 60 секунд
- стабильная нагрузка 4000 запросов в секунду
- параметр "replicas" не указан, "aсk" берется по кворуму - 2/3

Результаты нагрузочного тестирования:

    wrk -t4 -c16 -d60s -s ./get.lua -R4000 --latency http://127.0.0.1:8080
    Running 1m test @ http://127.0.0.1:8080
      4 threads and 16 connections
      Thread calibration: mean lat.: 2.432ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 2.411ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 2.407ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 2.439ms, rate sampling interval: 10ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     2.25ms    1.85ms  23.97ms   93.02%
        Req/Sec     1.06k   215.64     2.33k    83.85%
      Latency Distribution (HdrHistogram - Recorded Latency)
     50.000%    1.81ms
     75.000%    2.38ms
     90.000%    3.32ms
     99.000%   11.11ms
     99.900%   17.31ms
     99.990%   21.73ms
     99.999%   23.85ms
    100.000%   23.98ms
    
      Detailed Percentile spectrum:
           Value   Percentile   TotalCount 1/(1-Percentile)
    
           0.346     0.000000            1         1.00
           1.052     0.100000        20003         1.11
           1.269     0.200000        40018         1.25
           1.446     0.300000        60020         1.43
           1.620     0.400000        80006         1.67
           1.810     0.500000        99972         2.00
           1.911     0.550000       109999         2.22
           2.016     0.600000       120035         2.50
           2.127     0.650000       129994         2.86
           2.251     0.700000       140024         3.33
           2.385     0.750000       149967         4.00
           2.465     0.775000       155003         4.44
           2.559     0.800000       159955         5.00
           2.677     0.825000       164991         5.71
           2.831     0.850000       169990         6.67
           3.031     0.875000       174930         8.00
           3.163     0.887500       177441         8.89
           3.321     0.900000       179944        10.00
           3.543     0.912500       182442        11.43
           3.899     0.925000       184930        13.33
           4.535     0.937500       187436        16.00
           4.987     0.943750       188679        17.78
           5.503     0.950000       189930        20.00
           6.095     0.956250       191174        22.86
           6.799     0.962500       192423        26.67
           7.611     0.968750       193677        32.00
           8.015     0.971875       194299        35.56
           8.455     0.975000       194923        40.00
           8.935     0.978125       195549        45.71
           9.407     0.981250       196173        53.33
           9.927     0.984375       196805        64.00
          10.207     0.985938       197110        71.11
          10.519     0.987500       197427        80.00
          10.895     0.989062       197738        91.43
          11.271     0.990625       198048       106.67
          11.663     0.992188       198361       128.00
          11.919     0.992969       198518       142.22
          12.183     0.993750       198673       160.00
          12.503     0.994531       198828       182.86
          12.871     0.995313       198984       213.33
          13.319     0.996094       199142       256.00
          13.599     0.996484       199218       284.44
          13.879     0.996875       199297       320.00
          14.279     0.997266       199375       365.71
          14.679     0.997656       199451       426.67
          15.191     0.998047       199531       512.00
          15.567     0.998242       199569       568.89
          15.895     0.998437       199607       640.00
          16.295     0.998633       199646       731.43
          16.783     0.998828       199685       853.33
          17.359     0.999023       199724      1024.00
          17.647     0.999121       199744      1137.78
          17.903     0.999219       199763      1280.00
          18.223     0.999316       199783      1462.86
          18.623     0.999414       199802      1706.67
          19.359     0.999512       199822      2048.00
          19.535     0.999561       199833      2275.56
          19.647     0.999609       199841      2560.00
          19.855     0.999658       199851      2925.71
          20.063     0.999707       199863      3413.33
          20.479     0.999756       199871      4096.00
          20.687     0.999780       199876      4551.11
          20.783     0.999805       199880      5120.00
          21.039     0.999829       199885      5851.43
          21.247     0.999854       199890      6826.67
          21.455     0.999878       199895      8192.00
          21.615     0.999890       199898      9102.22
          21.743     0.999902       199900     10240.00
          21.999     0.999915       199902     11702.86
          22.191     0.999927       199905     13653.33
          22.447     0.999939       199907     16384.00
          22.575     0.999945       199909     18204.44
          22.703     0.999951       199910     20480.00
          22.719     0.999957       199911     23405.71
          22.847     0.999963       199912     27306.67
          22.927     0.999969       199913     32768.00
          22.959     0.999973       199914     36408.89
          23.151     0.999976       199915     40960.00
          23.151     0.999979       199915     46811.43
          23.759     0.999982       199916     54613.33
          23.759     0.999985       199916     65536.00
          23.855     0.999986       199917     72817.78
          23.855     0.999988       199917     81920.00
          23.855     0.999989       199917     93622.86
          23.919     0.999991       199918    109226.67
          23.919     0.999992       199918    131072.00
          23.919     0.999993       199918    145635.56
          23.919     0.999994       199918    163840.00
          23.919     0.999995       199918    187245.71
          23.983     0.999995       199919    218453.33
          23.983     1.000000       199919          inf
    #[Mean    =        2.250, StdDeviation   =        1.855]
    #[Max     =       23.968, Total count    =       199919]
    #[Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
      239973 requests in 1.00m, 16.63MB read
    Requests/sec:   3999.51
    Transfer/sec:    283.75KB
    
    
По результатам нагрузочного тестирования видно, что скорость обработки запросов по сравнению с предыдущим этапом увеличивается (в 2.69 раз для 99.9% запросов и в 2.05 раз для 99.999% запросов), что объясняется введением асинхронного выполнения запросов, таким образом, обращение к репликам идет параллельно, и сервер быстрее получает требуемое количество ответов (на предыдущем этапе сервер ждал, когда придет ответ от реплики, и только после этого отправлял запрос к следующей реплике). 
Также введена оптимизация, позволяющая не ждать ответ от всех реплик, а сформировать итоговый ответ при получении отклика от aсk реплик.

![async-profiler get cpu](pictures/stage6/cpu_get.svg)

 - 69.69% процессорного времени уходит на работу в пуле потоков (ThreadPoolExecutor.runWorker) 
 - 13.97% времени уходит на работу селектора сервера (SelectorThread.run)
 - 8.65% времени занимает селектор http-клиента (HttpClientImpl$SelectorManager.run)
 
 В пуле потоков потребление процессорного времени распределяется следующим образом:
 
 - 15.11% уходит на scheduler http-клиента (SequentialScheduler$SchedulableTask.run)
 - 9.64% занимает канал выдачи ответов от http-клиента (SocketTube)
 - 9.03% занимает получение задачи из пула потоков (ThreadPoolExecutor.getTask)
 - 5.75% уходит на завершение future и отправку ответа (Util.SendResponseFromFuture)
 - 29.93% занимают локальные вычисления (CompletableFuture.AsyncSupply)
 
 Локальные вычисления включают в себя:
 
 - получение данных из базы (BasicService.get - 18.29%)
 - отправку ответа серверу с полученными данными (CompletableFuture.PostComplete - 11.59%)

#### async-profiler alloc

![async-profiler get alloc](pictures/stage6/alloc_get.svg)

 - 40.96% памяти уходит на selectorThread
 - 3.62% памяти уходит на работу селектора http-клиента (HttpClientImpl$SelectorManager.run)
 - 55.24% памяти уходит на пул потоков
 
 В пуле потоков потребление памяти распределяется следующим образом:
 
 - 37.76% памяти потребляют локальные вычисления (в том числе, 25.82% памяти выделяется при получении данных из базы)
 - 11.94% памяти выделяется на завершение future и отправку ответа (CompletableFuture.Completion.run)
 - 1.66% памяти выделяется при получении задачи из пула потоков (ThreadPoolExecutor.getTask)
 - 0.84% памяти выделяется для канала выдачи ответов от http-клиента (SocketTube)
 - 6.25% памяти выделяется для scheduler http-клиента (SequentialScheduler$SchedulableTask.run)

#### async-profiler lock

![async-profiler get lock](pictures/stage6/lock_get.svg)

 - 32.64% блокировок происходят в менеджере http-клиента и связаны с с выбором задач на исполнение в асинхронном клиенте
 - 1.67% блокировок связаны с работой селектора сервера
 - 64.97% блокировок связаны с работой в пуле потоков
 
 В пуле потоков блокировки распределяются следующим образом:
 
 - 37.20% блокировок связаны с scheduler http-клиента и представляют собой, в основном, блокировки ConnectionPool и селектора
 - 3.39% блокировок связаны с получением задачи из пула потоков (ThreadPoolExecutor.getTask)
 - 23.81% блокировок связаны с локальными вычислениями (завершение future и отправка ответа от реплики) и представляют собой, в основном, блокировки ConnectionPool и селектора http-клиента
